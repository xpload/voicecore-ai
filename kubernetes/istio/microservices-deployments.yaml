# Updated Microservices Deployments with Istio Integration
# These deployments include proper labels and annotations for Istio service mesh

---
# Gateway Deployment
apiVersion: apps/v1
kind: Deployment
metadata:
  name: gateway
  namespace: voicecore-ai
  labels:
    app: gateway
    version: v1
    tier: microservice
spec:
  replicas: 3
  selector:
    matchLabels:
      app: gateway
      version: v1
  template:
    metadata:
      labels:
        app: gateway
        version: v1
        tier: microservice
      annotations:
        sidecar.istio.io/inject: "true"
        prometheus.io/scrape: "true"
        prometheus.io/port: "8000"
        prometheus.io/path: "/metrics"
    spec:
      containers:
      - name: gateway
        image: voicecore/gateway:latest
        ports:
        - containerPort: 8000
          name: http
          protocol: TCP
        env:
        - name: PORT
          value: "8000"
        - name: TENANT_SERVICE_URL
          value: "http://tenant-service:8001"
        - name: CALL_SERVICE_URL
          value: "http://call-service:8002"
        - name: AI_SERVICE_URL
          value: "http://ai-service:8003"
        - name: CRM_SERVICE_URL
          value: "http://crm-service:8004"
        - name: ANALYTICS_SERVICE_URL
          value: "http://analytics-service:8005"
        - name: INTEGRATION_SERVICE_URL
          value: "http://integration-service:8006"
        - name: BILLING_SERVICE_URL
          value: "http://billing-service:8007"
        resources:
          requests:
            cpu: 200m
            memory: 256Mi
          limits:
            cpu: 1000m
            memory: 1Gi
        livenessProbe:
          httpGet:
            path: /health
            port: 8000
          initialDelaySeconds: 30
          periodSeconds: 30
        readinessProbe:
          httpGet:
            path: /health
            port: 8000
          initialDelaySeconds: 10
          periodSeconds: 10

---
# Gateway Service
apiVersion: v1
kind: Service
metadata:
  name: gateway
  namespace: voicecore-ai
  labels:
    app: gateway
    service: gateway
spec:
  ports:
  - port: 8000
    targetPort: 8000
    name: http
  selector:
    app: gateway

---
# Tenant Service Deployment
apiVersion: apps/v1
kind: Deployment
metadata:
  name: tenant-service
  namespace: voicecore-ai
  labels:
    app: tenant-service
    version: v1
    tier: microservice
spec:
  replicas: 2
  selector:
    matchLabels:
      app: tenant-service
      version: v1
  template:
    metadata:
      labels:
        app: tenant-service
        version: v1
        tier: microservice
      annotations:
        sidecar.istio.io/inject: "true"
        prometheus.io/scrape: "true"
        prometheus.io/port: "8001"
    spec:
      containers:
      - name: tenant-service
        image: voicecore/tenant-service:latest
        ports:
        - containerPort: 8001
          name: http
          protocol: TCP
        env:
        - name: PORT
          value: "8001"
        - name: DATABASE_URL
          valueFrom:
            secretKeyRef:
              name: voicecore-secrets
              key: database-url
        - name: REDIS_URL
          valueFrom:
            secretKeyRef:
              name: voicecore-secrets
              key: redis-url
        resources:
          requests:
            cpu: 100m
            memory: 256Mi
          limits:
            cpu: 500m
            memory: 512Mi
        livenessProbe:
          httpGet:
            path: /health
            port: 8001
          initialDelaySeconds: 30
          periodSeconds: 30
        readinessProbe:
          httpGet:
            path: /health
            port: 8001
          initialDelaySeconds: 10
          periodSeconds: 10

---
# Tenant Service
apiVersion: v1
kind: Service
metadata:
  name: tenant-service
  namespace: voicecore-ai
  labels:
    app: tenant-service
    service: tenant-service
spec:
  ports:
  - port: 8001
    targetPort: 8001
    name: http
  selector:
    app: tenant-service

---
# Call Service Deployment
apiVersion: apps/v1
kind: Deployment
metadata:
  name: call-service
  namespace: voicecore-ai
  labels:
    app: call-service
    version: v1
    tier: microservice
spec:
  replicas: 3
  selector:
    matchLabels:
      app: call-service
      version: v1
  template:
    metadata:
      labels:
        app: call-service
        version: v1
        tier: microservice
      annotations:
        sidecar.istio.io/inject: "true"
        prometheus.io/scrape: "true"
        prometheus.io/port: "8002"
    spec:
      containers:
      - name: call-service
        image: voicecore/call-service:latest
        ports:
        - containerPort: 8002
          name: http
          protocol: TCP
        env:
        - name: PORT
          value: "8002"
        - name: DATABASE_URL
          valueFrom:
            secretKeyRef:
              name: voicecore-secrets
              key: database-url
        - name: REDIS_URL
          valueFrom:
            secretKeyRef:
              name: voicecore-secrets
              key: redis-url
        - name: TWILIO_ACCOUNT_SID
          valueFrom:
            secretKeyRef:
              name: voicecore-secrets
              key: twilio-account-sid
        - name: TWILIO_AUTH_TOKEN
          valueFrom:
            secretKeyRef:
              name: voicecore-secrets
              key: twilio-auth-token
        resources:
          requests:
            cpu: 200m
            memory: 512Mi
          limits:
            cpu: 1000m
            memory: 1Gi
        livenessProbe:
          httpGet:
            path: /health
            port: 8002
          initialDelaySeconds: 30
          periodSeconds: 30
        readinessProbe:
          httpGet:
            path: /health
            port: 8002
          initialDelaySeconds: 10
          periodSeconds: 10

---
# Call Service
apiVersion: v1
kind: Service
metadata:
  name: call-service
  namespace: voicecore-ai
  labels:
    app: call-service
    service: call-service
spec:
  ports:
  - port: 8002
    targetPort: 8002
    name: http
  selector:
    app: call-service

---
# AI Service Deployment
apiVersion: apps/v1
kind: Deployment
metadata:
  name: ai-service
  namespace: voicecore-ai
  labels:
    app: ai-service
    version: v1
    tier: microservice
spec:
  replicas: 2
  selector:
    matchLabels:
      app: ai-service
      version: v1
  template:
    metadata:
      labels:
        app: ai-service
        version: v1
        tier: microservice
      annotations:
        sidecar.istio.io/inject: "true"
        prometheus.io/scrape: "true"
        prometheus.io/port: "8003"
    spec:
      containers:
      - name: ai-service
        image: voicecore/ai-service:latest
        ports:
        - containerPort: 8003
          name: http
          protocol: TCP
        env:
        - name: PORT
          value: "8003"
        - name: OPENAI_API_KEY
          valueFrom:
            secretKeyRef:
              name: voicecore-secrets
              key: openai-api-key
        - name: REDIS_URL
          valueFrom:
            secretKeyRef:
              name: voicecore-secrets
              key: redis-url
        resources:
          requests:
            cpu: 500m
            memory: 1Gi
          limits:
            cpu: 2000m
            memory: 2Gi
        livenessProbe:
          httpGet:
            path: /health
            port: 8003
          initialDelaySeconds: 30
          periodSeconds: 30
        readinessProbe:
          httpGet:
            path: /health
            port: 8003
          initialDelaySeconds: 10
          periodSeconds: 10

---
# AI Service
apiVersion: v1
kind: Service
metadata:
  name: ai-service
  namespace: voicecore-ai
  labels:
    app: ai-service
    service: ai-service
spec:
  ports:
  - port: 8003
    targetPort: 8003
    name: http
  selector:
    app: ai-service

---
# CRM Service Deployment
apiVersion: apps/v1
kind: Deployment
metadata:
  name: crm-service
  namespace: voicecore-ai
  labels:
    app: crm-service
    version: v1
    tier: microservice
spec:
  replicas: 2
  selector:
    matchLabels:
      app: crm-service
      version: v1
  template:
    metadata:
      labels:
        app: crm-service
        version: v1
        tier: microservice
      annotations:
        sidecar.istio.io/inject: "true"
        prometheus.io/scrape: "true"
        prometheus.io/port: "8004"
    spec:
      containers:
      - name: crm-service
        image: voicecore/crm-service:latest
        ports:
        - containerPort: 8004
          name: http
          protocol: TCP
        env:
        - name: PORT
          value: "8004"
        - name: DATABASE_URL
          valueFrom:
            secretKeyRef:
              name: voicecore-secrets
              key: database-url
        - name: REDIS_URL
          valueFrom:
            secretKeyRef:
              name: voicecore-secrets
              key: redis-url
        resources:
          requests:
            cpu: 100m
            memory: 256Mi
          limits:
            cpu: 500m
            memory: 512Mi
        livenessProbe:
          httpGet:
            path: /health
            port: 8004
          initialDelaySeconds: 30
          periodSeconds: 30
        readinessProbe:
          httpGet:
            path: /health
            port: 8004
          initialDelaySeconds: 10
          periodSeconds: 10

---
# CRM Service
apiVersion: v1
kind: Service
metadata:
  name: crm-service
  namespace: voicecore-ai
  labels:
    app: crm-service
    service: crm-service
spec:
  ports:
  - port: 8004
    targetPort: 8004
    name: http
  selector:
    app: crm-service

---
# Analytics Service Deployment
apiVersion: apps/v1
kind: Deployment
metadata:
  name: analytics-service
  namespace: voicecore-ai
  labels:
    app: analytics-service
    version: v1
    tier: microservice
spec:
  replicas: 2
  selector:
    matchLabels:
      app: analytics-service
      version: v1
  template:
    metadata:
      labels:
        app: analytics-service
        version: v1
        tier: microservice
      annotations:
        sidecar.istio.io/inject: "true"
        prometheus.io/scrape: "true"
        prometheus.io/port: "8005"
    spec:
      containers:
      - name: analytics-service
        image: voicecore/analytics-service:latest
        ports:
        - containerPort: 8005
          name: http
          protocol: TCP
        env:
        - name: PORT
          value: "8005"
        - name: DATABASE_URL
          valueFrom:
            secretKeyRef:
              name: voicecore-secrets
              key: database-url
        - name: REDIS_URL
          valueFrom:
            secretKeyRef:
              name: voicecore-secrets
              key: redis-url
        resources:
          requests:
            cpu: 200m
            memory: 512Mi
          limits:
            cpu: 1000m
            memory: 1Gi
        livenessProbe:
          httpGet:
            path: /health
            port: 8005
          initialDelaySeconds: 30
          periodSeconds: 30
        readinessProbe:
          httpGet:
            path: /health
            port: 8005
          initialDelaySeconds: 10
          periodSeconds: 10

---
# Analytics Service
apiVersion: v1
kind: Service
metadata:
  name: analytics-service
  namespace: voicecore-ai
  labels:
    app: analytics-service
    service: analytics-service
spec:
  ports:
  - port: 8005
    targetPort: 8005
    name: http
  selector:
    app: analytics-service

---
# Integration Service Deployment
apiVersion: apps/v1
kind: Deployment
metadata:
  name: integration-service
  namespace: voicecore-ai
  labels:
    app: integration-service
    version: v1
    tier: microservice
spec:
  replicas: 2
  selector:
    matchLabels:
      app: integration-service
      version: v1
  template:
    metadata:
      labels:
        app: integration-service
        version: v1
        tier: microservice
      annotations:
        sidecar.istio.io/inject: "true"
        prometheus.io/scrape: "true"
        prometheus.io/port: "8006"
    spec:
      containers:
      - name: integration-service
        image: voicecore/integration-service:latest
        ports:
        - containerPort: 8006
          name: http
          protocol: TCP
        env:
        - name: PORT
          value: "8006"
        - name: REDIS_URL
          valueFrom:
            secretKeyRef:
              name: voicecore-secrets
              key: redis-url
        resources:
          requests:
            cpu: 100m
            memory: 256Mi
          limits:
            cpu: 500m
            memory: 512Mi
        livenessProbe:
          httpGet:
            path: /health
            port: 8006
          initialDelaySeconds: 30
          periodSeconds: 30
        readinessProbe:
          httpGet:
            path: /health
            port: 8006
          initialDelaySeconds: 10
          periodSeconds: 10

---
# Integration Service
apiVersion: v1
kind: Service
metadata:
  name: integration-service
  namespace: voicecore-ai
  labels:
    app: integration-service
    service: integration-service
spec:
  ports:
  - port: 8006
    targetPort: 8006
    name: http
  selector:
    app: integration-service

---
# Billing Service Deployment
apiVersion: apps/v1
kind: Deployment
metadata:
  name: billing-service
  namespace: voicecore-ai
  labels:
    app: billing-service
    version: v1
    tier: microservice
spec:
  replicas: 2
  selector:
    matchLabels:
      app: billing-service
      version: v1
  template:
    metadata:
      labels:
        app: billing-service
        version: v1
        tier: microservice
      annotations:
        sidecar.istio.io/inject: "true"
        prometheus.io/scrape: "true"
        prometheus.io/port: "8007"
    spec:
      containers:
      - name: billing-service
        image: voicecore/billing-service:latest
        ports:
        - containerPort: 8007
          name: http
          protocol: TCP
        env:
        - name: PORT
          value: "8007"
        - name: DATABASE_URL
          valueFrom:
            secretKeyRef:
              name: voicecore-secrets
              key: database-url
        - name: REDIS_URL
          valueFrom:
            secretKeyRef:
              name: voicecore-secrets
              key: redis-url
        - name: STRIPE_SECRET_KEY
          valueFrom:
            secretKeyRef:
              name: voicecore-secrets
              key: stripe-secret-key
        resources:
          requests:
            cpu: 100m
            memory: 256Mi
          limits:
            cpu: 500m
            memory: 512Mi
        livenessProbe:
          httpGet:
            path: /health
            port: 8007
          initialDelaySeconds: 30
          periodSeconds: 30
        readinessProbe:
          httpGet:
            path: /health
            port: 8007
          initialDelaySeconds: 10
          periodSeconds: 10

---
# Billing Service
apiVersion: v1
kind: Service
metadata:
  name: billing-service
  namespace: voicecore-ai
  labels:
    app: billing-service
    service: billing-service
spec:
  ports:
  - port: 8007
    targetPort: 8007
    name: http
  selector:
    app: billing-service
